---
title: "MCTP Flow"
date: 2025-09-25 00:00:00  +0500
categories: [BMC]
tags: [BMC]
---

## MCTP Communication Process: BMC to NIC

### **Communication Flow**

1.  **Initiation:** A management application on the BMC (e.g., a PLDM daemon for firmware update) needs to communicate with the NIC.

2.  **Payload Preparation:** The application prepares a PLDM message (e.g., `GetFirmwareParameters`).

3.  **MCTP Encapsulation:** The PLDM message is passed to the MCTP layer, which adds the MCTP header (Destination EID, Source EID, Message Type=PLDM, etc.).

4.  **PCIe VDM Encapsulation:** The MCTP packet is passed to the PCIe transport layer, which formats it as a PCIe Vendor-Defined Message (VDM) with a specific Vendor ID (e.g., DMTF's ID).

5.  **Hardware Transmission:** The BMC's PCIe root complex sends the VDM packet over the PCIe bus to the NIC.

6.  **Reception & Decapsulation:** The NIC receives the PCIe VDM, extracts the MCTP packet, and based on the Message Type field, delivers the PLDM payload to its PLDM handler.

7.  **Response:** The NIC's PLDM firmware processes the request, prepares a response, and the reverse process happens to send the reply back to the BMC.

---

## ASCII Diagram: MCTP Stack from User Space to Hardware

Here's how the complete stack looks for MCTP over PCIe VDM:

```
+------------------------------------------------------------------------------------------------------+
| BMC (Management Controller)                                                                          |
+-----------------------------+------------------------------------------------------------------------+
| User Space                  |  PLDM Firmware Update Tool |  PLDM Sensor Daemon |  Other PLDM Apps     |
|                             |  (e.g., pldmtool)          |                     |                      |
+-----------------------------+---------------------------+---------------------+----------------------+
|                             |  libpldm (PLDM Library)   |                     |                      |
|                             |  - Encodes/decodes PLDM   |                     |                      |
|                             |  - Handles PLDM instances |                     |                      |
+-----------------------------+---------------------------+---------------------+----------------------+
| MCTP User Space             |  MCTP Socket API          |  MCTP Socket API    |  MCTP Socket API     |
|                             |  (AF_MCTP family)         |                     |                      |
|                             |  - sendmsg()/recvmsg()    |                     |                      |
|                             |  - Binds to EID           |                     |                      |
+-----------------------------+---------------------------------------------------+----------------------+
| Kernel Space                |  MCTP Core Stack                                                                |
|                             +------------------------------------------------------------------------------+
|                             |  MCTP Network Layer (net/mctp/)                                                  |
|                             |  - Route management        - EID assignment       - Message reassembly          |
|                             |  - Socket implementation   - Device binding       - Transport abstraction        |
|                             +------------------------------------------------------------------------------+
|                             |  MCTP PCIe Transport Driver (e.g., mctp-pci.ko)                                   |
|                             |  - PCIe VDM encoding/decoding  - MCTP-over-PCIe spec implementation              |
|                             |  - Device discovery            - Endpoint management                             |
+-----------------------------+------------------------------------------------------------------------------+
| Hardware Abstraction        |  PCIe Subsystem / Linux PCI Core                                                |
|                             |  - PCIe configuration        - DMA management      - MSI/MSI-X interrupts       |
+-----------------------------+------------------------------------------------------------------------------+
| Hardware Layer              |  BMC SoC | PCIe Root Complex | PCIe Link | NIC (Endpoint)                      |
|                             |          |                   |           | PCIe Controller + Management Controller |
+-----------------------------+----------+-------------------+-----------+---------------------------------------+
| Physical                    |  ######## PCIe Serial Bus (Differential Pairs) ##########                         |
+------------------------------------------------------------------------------------------------------+
```

### **Detailed Stack Components Breakdown**

#### **BMC Side (Initiator):**

**User Space:**
- **PLDM Applications:** Tools like `pldmtool` or daemons that need to send PLDM commands.
- **libpldm:** User-space library that handles PLDM message encoding/decoding.
- **MCTP Socket API:** Applications use standard socket API (`socket(AF_MCTP, SOCK_DGRAM, 0)`) to communicate with MCTP endpoints.

**Kernel Space:**
- **MCTP Core Stack:**
  - Manages EID (Endpoint ID) routing table
  - Handles message fragmentation/reassembly
  - Provides the socket interface to user space
- **MCTP PCIe Transport Driver:**
  - Binds to PCIe devices that support MCTP
  - Encapsulates MCTP packets into PCIe Vendor-Defined Messages (VDMs)
  - Implements the MCTP-over-PCIe VDM specification
- **PCIe Subsystem:** Standard Linux PCI core that handles PCIe configuration and DMA.

**Hardware Layer:**
- **BMC SoC:** The main processor with integrated PCIe root complex.
- **PCIe Root Complex:** Generates PCIe transactions, including VDMs.

#### **NIC Side (Responder):**

**Hardware Layer:**
- **PCIe Controller:** Receives PCIe packets, recognizes VDMs.
- **Management Controller:** Dedicated microcontroller on the NIC that handles MCTP/PLDM messages independently of the main NIC data path.

**Firmware/Software on NIC:**
- **MCTP Handler:** Processes incoming MCTP packets, routes based on Message Type.
- **PLDM Firmware:** Implements PLDM commands specific to the NIC's capabilities (firmware update, sensor monitoring, etc.).

---

## Example Communication Sequence

```
BMC User Space App      BMC Kernel        BMC PCIe      PCIe Bus      NIC PCIe      NIC Firmware
     ↓                   ↓                 ↓             ↓             ↓             ↓
1.   |-- PLDM Request -->|                 |             |             |             |
     |                   |                 |             |             |             |
2.   |                   |-- MCTP Encaps -->|             |             |             |
     |                   | (Add EID, Type) |             |             |             |
     |                   |                 |             |             |             |
3.   |                   |                 |-- PCIe VDM -->|             |             |
     |                   |                 | (Add VDM Hdr) |             |             |
     |                   |                 |             |             |             |
4.   |                   |                 |             |=== PCIe VDM Packet ===>|             |
     |                   |                 |             |             |             |
5.   |                   |                 |             |             |-- VDM Receive -->|
     |                   |                 |             |             |             |
6.   |                   |                 |             |             |             |-- MCTP Extract -->|
     |                   |                 |             |             |             |             |
7.   |                   |                 |             |             |             |<- PLDM Process <-|
     |                   |                 |             |             |             |             |
8.   |                   |                 |             |             |<- Response VDM <-|             |
     |                   |                 |             |             |             |             |
9.   |                   |                 |<-- PCIe VDM --|             |             |             |
     |                   |                 |             |             |             |             |
10.  |                   |<-- MCTP Decap ---|             |             |             |             |
     |                   |                 |             |             |             |             |
11.  |<-- PLDM Response -|                 |             |             |             |             |
```

## Key Protocol Encapsulation

The actual data encapsulation looks like this:

```
+-----------------------------------------------------------------------------------------+
| PCIe Transaction Layer Packet (TLP)                                                     |
|   +-----------------------------------------------------------------------------------+ |
|   | PCIe Header (Includes Vendor-Specific TLP Type)                                  | |
|   +-----------------------------------------------------------------------------------+ |
|   | PCIe VDM Header (DMTF Vendor ID, etc.)                                           | |
|   +-----------------------------------------------------------------------------------+ |
|   | MCTP Packet                                                                      | |
|   |   +---------------------------------------------------------------------------+   | |
|   |   | MCTP Header (Dest EID, Src EID, Message Type=PLDM, etc.)                 |   | |
|   |   +---------------------------------------------------------------------------+   | |
|   |   | PLDM Message                                                              |   | |
|   |   |   +-------------------------------------------------------------------+   |   | |
|   |   |   | PLDM Header (Type, Command, Instance ID)                         |   |   | |
|   |   |   +-------------------------------------------------------------------+   |   | |
|   |   |   | PLDM Payload (e.g., Firmware Update Command Parameters)           |   |   | |
|   |   |   +-------------------------------------------------------------------+   |   | |
|   |   +---------------------------------------------------------------------------+   | |
|   +-----------------------------------------------------------------------------------+ |
+-----------------------------------------------------------------------------------------+
```

This layered approach provides the flexibility to run the same management protocols (PLDM) over different physical transports (PCIe, I2C, etc.) while maintaining a consistent application interface.
